<script type="text/javascript" src="./difflib-browser.js"></script>
<script>
    class SymbolsConverter{
        constructor(){
            this.words = []
        }
        uniqueWords(allText){
            // get words
            this.words = allText.split(' ').concat(this.words)
            this.words = [...new Set(this.words)]
        }
        fit(allText){
            this.uniqueWords(allText)
            // prepare translations table
            this.transTable = {}
            for (let i = 0; i < this.words.length; i++) {
                this.transTable[this.words[i]] = eval(`"\\u5${`${i}`.padStart(3, '0')}"`)
            }
        }
        transform(sentence) {
            sentence = sentence.split(' ')
            let encodedSent = []
            for (let i = 0; i < sentence.length; i++){
                encodedSent.push(this.transTable[sentence[i]])
            }
            return encodedSent.join('')
        }
        reverseTransform(encodedSent) {
            let original = []
            for (let i = 0; i < encodedSent.length; i++){
                let wordIndex = Object.values(this.transTable).indexOf(encodedSent[i])
                original.push(Object.keys(this.transTable)[wordIndex])
            }
            return original
        }
    }
</script>
<script>
    // highlight with words index
    class Comparer{
        constructor(original){
            this.original = original.trim()
            this.wordsMap = new Array(original.split(' ').length).fill(0)
            this.converter = new SymbolsConverter();
            this.converter.fit(original)
            this.compareCounter = 0
        }
        compare(trans){
            trans = trans.trim()
            this.converter.fit(trans)
            this.encodedOriginal = this.converter.transform(this.original)
            this.encodedTrans = this.converter.transform(trans)
            // get differences
            const seq = new difflib.SequenceMatcher(null, this.encodedOriginal, this.encodedTrans);
            this.diffs = seq.getOpcodes();
            // replace glitch
            this.diffs = this.#replaceGlitch()
            // this.diffs = this.#addPreview()
            // remove the last deleted diff
            if (this.diffs.at(-1)[0] !== 'equal') this.diffs.pop()
            if (this.compareCounter){
                for(const diffIndex in this.diffs) {
                    if (this.diffs[diffIndex][0] !== 'equal') {
                        this.diffs.shift()
                        break
                    }
                }
            }
            // fill the map array
            this.#fillMapArray(this.diffs)
            // increase the counter
            this.compareCounter++
        }
        #fillMapArray(){
            for(let diff of this.diffs) {
                let value = diff[0] === 'equal' ? 1 : 2
                for (let mapIndex = diff[1]; mapIndex < diff[2]; mapIndex++) {
                    // if (!this.wordsMap[mapIndex])
                    this.wordsMap[mapIndex] = value
                }
            }
            // fix skipped words
            let strMap = this.wordsMap.join(''), m;
            const regex = /(?<=1|2)0+(?=1|2)/g
            while ((m = regex.exec(strMap)) !== null) {
                // This is necessary to avoid infinite loops with zero-width matches
                if (m.index === regex.lastIndex) {
                    regex.lastIndex++;
                }
                // The result can be accessed through the `m`-variable.
                for (let i = m.index; i < m.index + m[0].length; i++){
                    this.wordsMap[i] = 2
                }
            }
        }
        #replaceGlitch(){
            return this.diffs.reduce((acc, current) => {
                let newCurrent = []
                if (current[0] == 'replace'){
                    if (current[4] - current[3] < current[2] - current[1]){
                        newCurrent = [...current]
                        newCurrent[2] = current[1] + current[4] - current[3]
                        acc.push(newCurrent)
                        // 
                        acc.push(['delete', newCurrent[2], current[2], current[3], current[3]])
                    }
                } else 
                    acc.push(current);
                return acc
            }, [])
        }
        #addPreview(){
            this.diffs = this.diffs.map((d) => {
                d.push(this.converter.reverseTransform(this.encodedOriginal.slice(d[1], d[2])).join(' '));
                d.push(this.converter.reverseTransform(this.encodedTrans.slice(d[3], d[4])).join(' '));
                return d;
            });
        }
        display(){
            let colors = []
            let words = this.original.split(' ').map(word => `%c${word}`).join(' ')  
            for (let color of this.wordsMap) {
                color = color === 2 ? "red" : color === 1 ? "green" : "black"
                colors.push(`color: ${color}`)
            }
            console.log(words, ...colors);
        }
    }
</script>
<script>
    /*
        0 ==> not recognized yet
        1 ==> correct
        2 ==> wrong
    */
    const data = {"verses":[{"id":13,"verse_key":"2:6","text_uthmani_simple":"ان الذين كفروا۟ سواء عليهم ءانذرتهم ام لم تنذرهم لا يؤمنون"},{"id":14,"verse_key":"2:7","text_uthmani_simple":"ختم الله على قلوبهم وعلى سمعهم وعلى ابصرهم غشوة ولهم عذاب عظيم"},{"id":15,"verse_key":"2:8","text_uthmani_simple":"ومن الناس من يقول ءامنا بالله وباليوم الءاخر وما هم بمؤمنين"},{"id":16,"verse_key":"2:9","text_uthmani_simple":"يخدعون الله والذين ءامنوا۟ وما يخدعون الا انفسهم وما يشعرون"},{"id":17,"verse_key":"2:10","text_uthmani_simple":"فى قلوبهم مرض فزادهم الله مرضا ولهم عذاب اليمۢ بما كانوا۟ يكذبون"},{"id":18,"verse_key":"2:11","text_uthmani_simple":"واذا قيل لهم لا تفسدوا۟ فى الارض قالوا۟ انما نحن مصلحون"},{"id":19,"verse_key":"2:12","text_uthmani_simple":"الا انهم هم المفسدون ولكن لا يشعرون"},{"id":20,"verse_key":"2:13","text_uthmani_simple":"واذا قيل لهم ءامنوا۟ كما ءامن الناس قالوا۟ انؤمن كما ءامن السفهاء الا انهم هم السفهاء ولكن لا يعلمون"},{"id":21,"verse_key":"2:14","text_uthmani_simple":"واذا لقوا۟ الذين ءامنوا۟ قالوا۟ ءامنا واذا خلوا۟ الى شيطينهم قالوا۟ انا معكم انما نحن مستهزءون"},{"id":22,"verse_key":"2:15","text_uthmani_simple":"الله يستهزئ بهم ويمدهم فى طغينهم يعمهون"},{"id":23,"verse_key":"2:16","text_uthmani_simple":"او۟لئك الذين اشتروا۟ الضللة بالهدى فما ربحت تجرتهم وما كانوا۟ مهتدين"}],"meta":{"filters":{"page_number":"3"}}}
    let transcripts = ['الذين كفروا۟ سواء عليهم', ' ام لم تنذرهم لا يؤمينون', 'ءانذرتهم ام لم تنذرهم لا يؤمنون', 'ختم الله على قلوبهم وسمعهم']
    let original = data.verses.map(verse => verse.text_uthmani_simple).join(" ")
    const comparer = new Comparer(original)
    for (let transcript of transcripts){
        comparer.compare(transcript)
        comparer.display()
    }
    console.log(comparer.wordsMap)
</script>